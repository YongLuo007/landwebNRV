{
    "contents" : "################################################################################\n#' purify SK PSP data \n#' \n#' \n#' @param SADataRaw  data table, is age_samples in the MS access file\n#' \n#' \n#' @param plotHeaderRaw data.table, is plot_header in MS access file\n#' \n#' @param measureHeaderRaw data.table, is mearsurement_header in MS access file\n#'        \n#' @param treeDataRaw data.table, is trees in MS access file\n#'\n#' @return  two data tables, the first one head data, which contains the location and SA info.\n#'                           the second one is purified tree data, which contains inividual tree infor.\n#'                           for the tree data, all trees are alive.\n#'                      \n#'\n#' @note no note\n#'\n#' @seealso no\n#'\n#' @include \n#' @export\n#' @docType methods\n#' @rdname dataPurification_SKPSP\n#'\n#' @author Yong Luo\n#'\n#' @examples\n#' \\dontrun{\n#' \n#' }\nsetGeneric(\"dataPurification_SKPSP\", function(SADataRaw, plotHeaderRaw,\n                                              measureHeaderRaw, treeDataRaw) {\n  standardGeneric(\"dataPurification_SKPSP\")\n})\n#' @export\n#' @rdname dataPurification_SKPSP\nsetMethod(\n  \"dataPurification_SKPSP\",\n  signature = c(SADataRaw = \"data.table\", \n                plotHeaderRaw = \"data.table\",\n                measureHeaderRaw = \"data.table\",\n                treeDataRaw = \"data.table\"),\n  definition = function(SADataRaw, plotHeaderRaw,\n                        measureHeaderRaw, treeDataRaw) {\n    # range(SADataRaw$COUNTED_AGE) # NA NA\n    # range(SADataRaw$TOTAL_AGE) # NA NA\n    # unique(SADataRaw$TREE_STATUS)\n    header_SA <- SADataRaw[!is.na(TOTAL_AGE) & TREE_STATUS == 1,]\n    header_SA[, baseYear := min(YEAR), by = PLOT_ID]\n    header_SA[, treeAge := TOTAL_AGE-(YEAR-baseYear)]\n    header_SA_Dom <- header_SA[CROWN_CLASS == 1,] # the stand age first determined by dominant trees\n    header_SA_Dom[, NofTrees:=length(CROWN_CLASS), by  = PLOT_ID]\n    # unique(SADataRawDomSA$NofTrees) # 1 2 3 4 5\n    # stand age must determined by using at least 2 trees\n    header_SA_Dom <- header_SA_Dom[NofTrees != 1,]\n    # SADataRawDomSA[, treeAgeDif:=max(treeAge)-min(treeAge), by = PLOT_ID]\n    # range(SADataRawDomSA$treeAgeDif) # 0 44\n    # mean(SADataRawDomSA$treeAgeDif) # 7.03\n    header_SA_Dom[, baseSA:=as.integer(mean(treeAge)), by = PLOT_ID]\n    header_SA_Dom <- unique(header_SA_Dom[,.(PLOT_ID, baseYear, baseSA)], by = \"PLOT_ID\")\n    # for the other plots determine SA using codominant trees\n    header_SA_CoDom <- header_SA[CROWN_CLASS == 2,]\n    \n    header_SA_CoDom <- header_SA_CoDom[!(PLOT_ID %in% unique(header_SA_Dom$PLOT_ID)),]\n    header_SA_CoDom[, NofTrees:=length(CROWN_CLASS), by  = PLOT_ID]\n    # unique(SADataRawCodomSA$NofTrees)\n    header_SA_CoDom <- header_SA_CoDom[NofTrees != 1,]\n    header_SA_CoDom[, baseSA:=as.integer(mean(treeAge)), by = PLOT_ID]\n    header_SA_CoDom <- unique(header_SA_CoDom[,.(PLOT_ID, baseYear, baseSA)], by = \"PLOT_ID\") \n    headData_SA <- rbind(header_SA_Dom, header_SA_CoDom)\n    \n    headData_loca <- plotHeaderRaw[PLOT_ID %in% unique(headData_SA$PLOT_ID),][\n      ,.(PLOT_ID, Z13nad83_e, Z13nad83_n, Zone = 13)]\n    names(headData_loca)[2:3] <- c(\"Easting\", \"Northing\")\n    headData_SALoca <- setkey(headData_SA, PLOT_ID)[setkey(headData_loca, PLOT_ID),\n                                                    nomatch = 0]\n    headData_PS <- measureHeaderRaw[PLOT_ID %in% unique(headData_SALoca$PLOT_ID),][\n      ,.(PLOT_ID, PLOT_SIZE)][!is.na(PLOT_SIZE),]\n    headData_PS <- unique(headData_PS, by = \"PLOT_ID\")\n    setnames(headData_PS, \"PLOT_SIZE\", \"PlotSize\")\n    headData <- headData_SALoca[setkey(headData_PS, PLOT_ID), nomatch = 0]\n    \n    \n    # for tree data\n    treeDataRaw <- treeDataRaw[PLOT_ID %in% headData$PLOT_ID,][\n      ,.(PLOT_ID, TREE_NO, YEAR, SPECIES, DBH, HEIGHT, TREE_STATUS, \n         CONDITION_CODE1, CONDITION_CODE2, CONDITION_CODE3, MORTALITY)]\n    \n    # check the living trees\n    # 1. by tree status codes\n    #     1 1 Live\n    #     2 2 Declining\n    #     3 3 Dead or dying\n    #     4 4 Loose bark snag\n    #     5 5 Clean snag\n    #     6 6 Snag with broken top\n    #     7 7 Decomposed snag.\n    #     8 8 Down snag\n    #     9 9 Stump\n    treeData <- treeDataRaw[is.na(TREE_STATUS) | # conservtively\n                              TREE_STATUS == 0 |\n                              TREE_STATUS == 1 |\n                              TREE_STATUS == 2,]\n    # 2. by mortality codes\n    #     Null 0\n    #     Natural or Undetermined 1\n    #     Disease 2\n    #     Insect 3\n    #     Human 4\n    #     Wind 5\n    #     Snow 6\n    #     Other Trees 7\n    #     Hail or Ice Storm 8\n    treeData <- treeData[MORTALITY == 0 |\n                           is.na(MORTALITY),]\n    # check the trees with both status and mortality are NA\n    # unique(treeDataRaw[is.na(TREE_STATUS) & is.na(MORTALITY), ]$CONDITIONCODE1)\n    # NULL\n    treeData <- treeData[,.(PLOT_ID, OrigPlotID2 = NA, YEAR, TREE_NO, SPECIES,  DBH, HEIGHT)]\n    names(treeData) <- c(\"OrigPlotID1\", \"OrigPlotID2\", \"MeasureYear\", \"TreeNumber\", \"Species\",\n                            \"DBH\", \"Height\")\n    setnames(headData, \"PLOT_ID\", \"OrigPlotID1\")\n    measureidtable <- unique(treeData[,.(OrigPlotID1, MeasureYear)], by = c(\"OrigPlotID1\", \"MeasureYear\"))\n    measureidtable[,MeasureID:=paste(\"SKPSP_\", row.names(measureidtable), sep = \"\")]\n    measureidtable <- measureidtable[,.(MeasureID, OrigPlotID1, MeasureYear)]\n    treeData <- setkey(measureidtable, OrigPlotID1, MeasureYear)[setkey(treeData, OrigPlotID1, MeasureYear),\n                                                            nomatch = 0]\n    treeData <- treeData[,.(MeasureID, OrigPlotID1, OrigPlotID2, MeasureYear,\n                            TreeNumber, Species,  DBH, Height)]\n    headData <- setkey(measureidtable, OrigPlotID1)[setkey(headData, OrigPlotID1),\n                                               nomatch = 0]\n    headData <- headData[,.(MeasureID, OrigPlotID1, MeasureYear, Longitude = NA,\n                                Latitude = NA, Zone, Easting, Northing, PlotSize, baseYear,\n                                baseSA)]\n    return(list(plotHeaderData = headData, treeData = treeData))\n  })\n",
    "created" : 1461630654097.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3483644223",
    "id" : "7069399D",
    "lastKnownWriteTime" : 1461632482,
    "path" : "~/GitHub/landwebNRV/landwebNRV/R/dataPurification_SKPSP.R",
    "project_path" : "R/dataPurification_SKPSP.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "source_on_save" : false,
    "type" : "r_source"
}